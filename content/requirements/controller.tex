% Begin Controller
\subsection{Controller}

\subitem{
    The Controller computes actuator setpoints from planned trajectories and state estimates.
    It implements required control algorithms and scheduling, ensuring safe and efficient operation
    of the UAV actuators. The Controller is comprised of four submodules: Preprocessor, PVA Controller,
    ATL Controller, and Control Distributor. Each submodule contributes to translating planned trajectories
    into actuator commands.
}

\subsubsection{Interfaces}
\paragraph{Inputs}
\begin{enumerate}
    \item Planned goal state defined in \S3.3.1.2.1
    \item State mask as defined in \S3.3.1.2.1
    \item State estimates defined in \S3.2.1.2.1
    \item Controller configuration parameters
\end{enumerate}
\paragraph{Outputs}
\begin{enumerate}
    \item Actuator setpoints for ailerons, elevator, rudder, and throttle(s)
    \item Logging data containing any combination of control events, diagnostics, and error reports
\end{enumerate}
\paragraph{Internal}
\begin{enumerate}
    \item Position, velocity, and acceleration state and setpoints
    \item Attitude, angular rate, and throttle state and setpoints
    \item Attitude, angular rate, and throttle targets
    \item Intermediary setpoints for ailerons, elevator, rudder, and throttle(s)
\end{enumerate}


\subsubsection{Preprocessor}
\subitem{
    The Preprocessor submodule is responsible for setting up inputs and setpoints for 
    the controller chain given the desired operating mode.
}

\begin{enumerate}
% \paragraph{Functional Requirements}
    \item The preprocessor shall consume planned goal states as defined in \S3.4.1.1.1.
    \item The preprocessor shall consume state estimates as defined in \S3.4.1.1.3.
    \item The preprocessor shall output processed state and setpoints for the PVA controller as defined in \S3.4.1.3.1.
    \item The preprocessor shall output processed attitude and throttle state and setpoints for the ATL controller as defined in \S3.4.1.3.2.
    \item The preprocessor shall consume controller configuration parameters as defined in \S3.4.1.1.4.
% \textbf{Energy}
    \item The preprocessor shall not consume more than 5\% of the selected processing unit's bandwidth.
% \textbf{Environments}
    \item The preprocessor shall be function agnostic to the UAV environment.
    \item The preprocessor shall apply saturation and rate limits to setpoints determined by the controller configuration and UAV state.
% \textbf{Safety}
    \item The preprocessor shall log invalid or out-of-bounds inputs for diagnostics.
    \item The preprocessor shall set outputs to hold the current setpoints for a single cycle, then the current position, when missing or invalid inputs.
    \item The preprocessor shall ensure disable or zero all forward feeding control chains non-flight conditions.
% \textbf{Structure}
    \item The preprocessor shall enable and disable states and setpoints based on the current operating mode.
    \item The preprocessor shall output the exact state it receives unless zeroing for disabled setpoints.
    \item The preprocessor shall output the exact setpoints it receives modified only by slewing unless zeroing for disabled setpoints.
% \textbf{Standards and Regulations}
    \item The preprocessor shall adhere to all coding standards defined under \S3.1.1.7 and \S3.1.5.
\end{enumerate}

\subsubsection{PVA Controller}
\subitem{
    The PVA (Position/Velocity/Acceleration) Controller submodule computes control setpoints to track
    planned trajectories and maintain the UAV along the desired path.
}

\begin{enumerate}
% \paragraph{Functional Requirements}
    \item The PVA controller shall consume setpoints and state estimates as defined in \S3.4.1.3.1.
    \item The PVA controller shall output desired attitude and torque targets as defined in \S3.4.1.3.3.
    \item The PVA controller shall consume controller configuration parameters as defined in \S3.4.1.1.4.
% \textbf{Energy}
    \item The PVA controller shall not consume more than 10\% of the selected processing unit's bandwidth.
% \textbf{Environments}
    \item The PVA controller shall maintain stability with up to 20\% sensor noise.
    \item The PVA controller shall expose gains and tuning parameters via configuration.
    \item The PVA controller shall reject external disturbances, such that tuning the gains allows for tracking a parobilic position input with maximum steady state error 2x the platform size.
% \textbf{Safety}
    \item The PVA controller shall ensure bounded errors and proper saturation handling.
    \item The PVA controller shall log control errors and saturation events for diagnostics.
    \item The PVA controller shall be stall aware and prevent commands that would lead to stalling.
% \textbf{Structure}
    \item The PVA controller shall expose setpoints for position, velocity, and acceleration in three dimensions.
% \textbf{Standards and Regulations}
    \item The PVA controller shall adhere to all coding standards defined under \S3.1.1.7 and \S3.1.5.
\end{enumerate}

\subsubsection{ATL Controller}
\subitem{
    The ATL (Attitude/throttle-Level) Controller submodule translates higher-level commands
    into low-level actuator commands, respecting actuator limits and constraints.
}

\begin{enumerate}
% \paragraph{Functional Requirements}
    \item The ATL controller shall consume setpoints and state estimates as defined in \S3.4.1.3.2.
    \item The ATL controller shall consume setpoints as defined in \S3.4.1.3.3.
    \item The ATL controller shall output low-level intermediary actuator commands as defined in \S3.4.1.3.4.
    \item The PVA controller shall consume controller configuration parameters as defined in \S3.4.1.1.4.
% \textbf{Energy}
    \item The ATL controller shall not consume more than 10\% of the selected processing unit's bandwidth.
% \textbf{Environments}
    \item The ATL controller shall maintain stability with up to 20\% sensor noise.
    \item The ATL controller shall expose gains and tuning parameters via configuration.
    \item The ATL controller shall reject external disturbances, such that tuning the gains allows for tracking a ramp attitude input with maximum steady state error of 1 degree.
% \textbf{Safety}
    \item The ATL controller shall ensure bounded errors and proper saturation handling.
    \item The ATL controller shall log control errors and saturation events for diagnostics.
    \item The ATL controller shall be stall aware and prevent commands that would lead to stalling.
% \textbf{Structure}
    \item The ATL controller shall expose setpoints for attitude and angular velocity in three dimensions.
    \item The ATL controller shall expose throttle setpoints independent of attitude and angular velocity.
% \textbf{Standards and Regulations}
    \item The ATL controller shall adhere to all coding standards defined under \S3.1.1.7 and \S3.1.5.
\end{enumerate}

\subsubsection{Control Distributor}
\subitem{
    The Control Distributor submodule routes control outputs to the correct actuator channels,
    mapping and distributing logical control channels to physical hardware outputs.
}

\begin{enumerate}
% \paragraph{Functional Requirements}
    \item The control distributor shall consume low-level intermediary actuator commands as defined in \S3.4.1.3.4.
    \item The control distributor shall output hardware actuator signals as defined in \S3.4.1.2.1.
    \item The control distributor shall consume controller configuration parameters as defined in \S3.4.1.1.4.
% \textbf{Energy}
    \item The control distributor shall not consume more than 5\% of the selected processing unit's bandwidth.
% \textbf{Environments}
    \item The control distributor shall be functional agnostic to the UAV environment.
    \item The control distributor shall detect and handle hardware failures gracefully.
    \item The control distributor shall support testing the configured output map while not in flight.
% \textbf{Safety}
    \item The control distributor shall be robust to configuration errors.
    \item The control distributor shall log routing errors and hardware failures for diagnostics.
    \item The control distributor shall attempt to continue operation in the presence of hardware output failures.
    \item The control distributor shall disable outputs to all throttle channels when not in an armed flight mode.
% \textbf{Structure}
    \item The control distributor shall map logical control channels to physical hardware outputs based on configuration.
% \textbf{Standards and Regulations}
    \item The control distributor shall adhere to all coding standards defined under \S3.1.1.7 and \S3.1.5.
\end{enumerate}

%%% End Controller